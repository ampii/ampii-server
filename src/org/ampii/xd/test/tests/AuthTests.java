// This file is part of the AMPII Project. It is subject to the copyright and license terms in the top-level LICENSE file.
package org.ampii.xd.test.tests;

import org.ampii.xd.common.Errors;
import org.ampii.xd.common.XDException;
import org.ampii.xd.security.AuthManager;
import org.ampii.xd.server.HTTP;
import org.ampii.xd.test.Test;
import org.ampii.xd.test.TestException;

/**
 * Tests for the /.auth data and its functionality.
 * <p>
 * Add this class to the config file indicated by Application.testDefinitionFile if you want these tests to run.
 *
 * @author daverobin
 */
public class AuthTests {

    public static Test[] tests = {
            new Test("TLS Activation Test") {
                public void execute() throws TestException {

                    // reset to factory default conditions
                    try { AuthManager.resetToFactoryDefaults(); } catch (XDException e) { fail("resetToFactoryDefaults() failed",e); }

                    // check factory default conditions
                    step("check initial dev-cert");
                    path("/.auth/dev-cert");
                    clientData("<OctetString/>");
                    get();
                    expectClientData("<OctetString value=''/>");

                    step("check initial ca-certs");
                    path("/.auth/ca-certs");
                    clientData("<List/>");
                    get();
                    expectSuccessCode();
                    expectClientData("<List/>");

                    // then write stuff
                    alt("plain");  // we do this all in plain text

                    step("write dev-cert-pend");
                    path("/.auth/dev-cert-pend");
                    clientData("<OctetString value='308203E2308202CAA00302010202021234300D06092A864886F70D0101050500306E310B30090603550406130255533110300E0603550408130747656F726769613110300E0603550407130741746C616E74613111300F060355040A1308414D504949204341312830260603550403131F616D7069692E6F726720436572746966696361746520417574686F72697479301E170D3135313230323232313632325A170D3136313230313232313632325A307D310B30090603550406130255533110300E0603550408130747656F726769613110300E0603550407130741746C616E7461310E300C060355040A1305414D504949313A30380603550403133162343636626633323663343334316336623166643936333531363465346630312E6465766963652E616D7069692E6F726730820122300D06092A864886F70D01010105000382010F003082010A0282010100A6B065DF05634806A71B3BB5915A9A3FFD060A1D38373314BF181002EDE0485ABA8FC26A71D51D3941464EC153D5F6AD0F2D177829D2A8AE33CA32744A803A54BD477E71175E789C2D84ACDA07ACF13D6AC08F41DE1D8239244FD885508E376DF10621D6DE8A986E87BE25C2B92515424F451DAB90306C59736EB68ADCB330F745B33DE9E6602E6E0D4E53EAA97D174EEB691E8956D0EB57657C6A77EBD2B6A0E7C54724780C56FBC5B958894242CB39A213D329725ACA514532808DA439A996561CE81427E02D239FE0C9C12F9CB0E4B116B8A9DC0A5D1B7171CBF86F30E6EB29235C246480910BDA29FA008F41D41EC2FCB1AD215DF2C7889BE84F2DFDEE9D0203010001A37B307930090603551D1304023000302C06096086480186F842010D041F161D4F70656E53534C2047656E657261746564204365727469666963617465301D0603551D0E04160414E094B905E7FF15DB7C9B68F90736BDD893F9DEFA301F0603551D23041830168014F0FCA52F7CEAFB41C0A1097651223C00599A3230300D06092A864886F70D010105050003820101006D7EB7DC216F05CF7B88DFA06325908B83C8DF8AA937CC3B8C81C35853C54E172B9820C74F2DDAC5912AB7F5AC933A9A21418E20036A0FFBD65296FB59CB7E0880F2DA34393416396B8CB9820BF80E29CEC97C57A51B6FD79CCE7E130E386B43DD462CBCFC681D66E594FAF77E44EA844CC284CB0AF88BC05FFC2B6E25C8B2D3283CFED9EF40F8E55C570C9FE38B90E5D9ED2B4BB16343AB066568178AE6A0B94B350A6E761DB0368E2FD52889805A30DEA45047D8C7B427A2EB07477AF537D27606A4F310CBDDFD9EB102652CE9717F52ABCB6B0813D6EACD0479E9FD76BFB65951D105A44B42A6C11FC6865BD2BEAAAEAD6A6974E50B8F10EA563DB2C7F9D2'/>");
                    put();
                    expectSuccessCode();

                    step("write dev-key-pend");
                    path("/.auth/dev-key-pend");
                    clientData("<OctetString value='308204BF020100300D06092A864886F70D0101010500048204A9308204A50201000282010100A6B065DF05634806A71B3BB5915A9A3FFD060A1D38373314BF181002EDE0485ABA8FC26A71D51D3941464EC153D5F6AD0F2D177829D2A8AE33CA32744A803A54BD477E71175E789C2D84ACDA07ACF13D6AC08F41DE1D8239244FD885508E376DF10621D6DE8A986E87BE25C2B92515424F451DAB90306C59736EB68ADCB330F745B33DE9E6602E6E0D4E53EAA97D174EEB691E8956D0EB57657C6A77EBD2B6A0E7C54724780C56FBC5B958894242CB39A213D329725ACA514532808DA439A996561CE81427E02D239FE0C9C12F9CB0E4B116B8A9DC0A5D1B7171CBF86F30E6EB29235C246480910BDA29FA008F41D41EC2FCB1AD215DF2C7889BE84F2DFDEE9D0203010001028201002EBCF75379674522D868426DBEBBF0D45056092FF83B420F67259017C22B491E678137BA3100D898DD3CA18883C152D16397F924B0556906AF6EDA86D0FCF35E1F549497913DE403A69FB4F7CD7F288558117619B9F5FC359980E9ED379128E9A2D35D59AA3CA2511BAEAD57D42219BBE60E332B8FDA8406F0DEF2402D71F1207080427C4172F06C764704FF4EA0D23310AF0B8A42BFBAFE131A8E42D7C85812D21F084CEF013E68F93F93AD7B9138CC98FA28C89F1894A873F15A34060C7050239AA6A3D7A4A83A9FC23E1C979B71173CFEA5762369D8359C08A497AB3B3E1E4AA452F1AE2A3AB9D6378B749DE19D1C0943E46C43DC235D6BA9F4AD3FD1010102818100D41921A259484A323CF3C4865AF681A6EFA7D24ADE04564817BF8DA38586761D1EEE40D90D270B2F1E18EC413637D4A25E10E70449695708CC08FE8907C95481451A6FD100A9266EFEE9052A077E58CE3157C175C3E312CF7EE6DF3B3C36B81DDDD36BB225E63C771DBAD2902EA18B5AD40878DA0801C2A59146AB77A1F4F65502818100C931154E8485DDC724E544F77B371C02A9CF64A221BAAB9A6B5FE5007311F73F8BF66B6F8975533C5508E4E936BF015207D88C09691F17A833420D7A68F14D709FA05CDDDE8AF319B6BE832F8A4E2573CF20AC3E1CD5A8973A73BC07FBFDF40BEB183F7DEE6A818CCF5C84C69EF37ED9E961EBB2FF62FF4BC5F82C22B6858F29028181008CC791979D036A9C25F0F784E663B07309A7AEE19AB3EE4133E2253560AF7B3EA1052B6DE65900076A46C8AA103EC6986F2F70E75B82DC0E2EBFD99342E3D37F6A4ABDE55036F617BE8314B66CFAE41F18895313C3CDB8F2991CCD17184489B8E94027BFBB8032AA2DC58F75BC3DE5AD8807878FD0B8BA66032391347AFF897102818100959C816AAD13DB333F159B2EAA1AF62268E287C4256EEA335FCBA4C0ABD15D5A8D1B47135F55B6FAF38534ACD4803F5C1FE78163721FA3F8F97D1206C84940BC12882EE6F299C36388C8AD474A0308C8D0EB4C0AB8688E013F7F57015CFBA162C78575999114F497A08FFD50B25D0224CBEF7C55D4A26A948F7818620BF6CFD902818100ABBFBE8C427920BA891A6EEAA4917D4AE508DD0680B7F5618669E4775A679233F179B4F5E0F43F4D814C14C7D0CBD803EF44BA62754A190E636D6975E79400083155BBF1FB86EE5CCD42660B16DB4A41F13A3C81543993F185350783272F9A3B64C8DBD5A5014C835D8F38CE347D430EE13238230F4B3264E7CF8D8821213E10'/>");
                    put();
                    expectSuccessCode();

                    step("write ca-certs-pend");
                    path("/.auth/ca-certs-pend");
                    clientData("<OctetString name='1' value='308204333082031BA00302010202090083297BBEA7D8A228300D06092A864886F70D0101050500306E310B30090603550406130255533110300E0603550408130747656F726769613110300E0603550407130741746C616E74613111300F060355040A1308414D504949204341312830260603550403131F616D7069692E6F726720436572746966696361746520417574686F72697479301E170D3135313230323231353031385A170D3138303832373231353031385A306E310B30090603550406130255533110300E0603550408130747656F726769613110300E0603550407130741746C616E74613111300F060355040A1308414D504949204341312830260603550403131F616D7069692E6F726720436572746966696361746520417574686F7269747930820122300D06092A864886F70D01010105000382010F003082010A0282010100E67E09B15F8EF5D8BCD50B1375101EB559A097D84F658298581A0CE30632BF6A4615100FC8924503942117023EFB857139C7BD363EA9B8BD6564EF0F68E23031EF3CAA79B2F73696EAD5C9AF621D1B3E1DC1822457952890729C1A7C7AB4A4A4F7413998540D8FFB33A55787C7E36C81BC6A7B06126767C930517FF46CA688E533DD4BE773EB4163F58024894D81DFD17499B716B7645FB9CCCA8F23AFEB8BEDE4EBBE3B45651F443BDDB5E649DAAB703CD8A9C13014AE29575E72C74B8E65207945ABF0E5A782BEB953E0B643C8C3191D1F3FB84D167C71500E43ACB4E31529B34E8E2A24055A02412D914FD303BD99C2D67BBF43BEB3607A245856596D184F0203010001A381D33081D0301D0603551D0E04160414F0FCA52F7CEAFB41C0A1097651223C00599A32303081A00603551D230481983081958014F0FCA52F7CEAFB41C0A1097651223C00599A3230A172A470306E310B30090603550406130255533110300E0603550408130747656F726769613110300E0603550407130741746C616E74613111300F060355040A1308414D504949204341312830260603550403131F616D7069692E6F726720436572746966696361746520417574686F7269747982090083297BBEA7D8A228300C0603551D13040530030101FF300D06092A864886F70D0101050500038201010072FB91961F6AD3DA4F8FA741698B7EB89C4AD1F50BBCD52B5AB2202FACA7F07482BB619FAD0B58FCEE13A897CD8448FC99084FBDE640B0D6E38F4FF59529DCF5EE0ACD3E87F25C26EA8B86160D8822CB991DE399A9C145B856DB4BA79969D884D871137840E18F5C61B811BD3A317220E8C0FC486A5CC63F5EF3AFAC86DCF3C73345448E9949942E9C261B14641172AA69A75A70C36E395852D867DA35A0DB4458D6E7C9DAB8E7286F86F12E4C741EA2D9954E1AE06F7B5BDAFEB9A1B7E5FFFC6160A707048A67E5F001245BBE380777590FD96657F59C7B88E0DE15DD71BB6E7DDF1361E083D41788264E077012DBF74E032AE8F403050F1807B7E8EECF167D'/>");
                    post();
                    expectSuccessCode();

                    // activate!
                    step("write tls-activate");
                    clientData("<Boolean value='true'/>");
                    path("/.auth/tls-activate");
                    put();
                    expectSuccessCode();

                    // check results of activation
                    alt("default");  // switch back to xml or json for this
                    step("check activated dev-cert");
                    clientData("<OctetString/>");
                    path("/.auth/dev-cert");
                    get();
                    expectClientData("<OctetString value='308203E2308202CAA00302010202021234300D06092A864886F70D0101050500306E310B30090603550406130255533110300E0603550408130747656F726769613110300E0603550407130741746C616E74613111300F060355040A1308414D504949204341312830260603550403131F616D7069692E6F726720436572746966696361746520417574686F72697479301E170D3135313230323232313632325A170D3136313230313232313632325A307D310B30090603550406130255533110300E0603550408130747656F726769613110300E0603550407130741746C616E7461310E300C060355040A1305414D504949313A30380603550403133162343636626633323663343334316336623166643936333531363465346630312E6465766963652E616D7069692E6F726730820122300D06092A864886F70D01010105000382010F003082010A0282010100A6B065DF05634806A71B3BB5915A9A3FFD060A1D38373314BF181002EDE0485ABA8FC26A71D51D3941464EC153D5F6AD0F2D177829D2A8AE33CA32744A803A54BD477E71175E789C2D84ACDA07ACF13D6AC08F41DE1D8239244FD885508E376DF10621D6DE8A986E87BE25C2B92515424F451DAB90306C59736EB68ADCB330F745B33DE9E6602E6E0D4E53EAA97D174EEB691E8956D0EB57657C6A77EBD2B6A0E7C54724780C56FBC5B958894242CB39A213D329725ACA514532808DA439A996561CE81427E02D239FE0C9C12F9CB0E4B116B8A9DC0A5D1B7171CBF86F30E6EB29235C246480910BDA29FA008F41D41EC2FCB1AD215DF2C7889BE84F2DFDEE9D0203010001A37B307930090603551D1304023000302C06096086480186F842010D041F161D4F70656E53534C2047656E657261746564204365727469666963617465301D0603551D0E04160414E094B905E7FF15DB7C9B68F90736BDD893F9DEFA301F0603551D23041830168014F0FCA52F7CEAFB41C0A1097651223C00599A3230300D06092A864886F70D010105050003820101006D7EB7DC216F05CF7B88DFA06325908B83C8DF8AA937CC3B8C81C35853C54E172B9820C74F2DDAC5912AB7F5AC933A9A21418E20036A0FFBD65296FB59CB7E0880F2DA34393416396B8CB9820BF80E29CEC97C57A51B6FD79CCE7E130E386B43DD462CBCFC681D66E594FAF77E44EA844CC284CB0AF88BC05FFC2B6E25C8B2D3283CFED9EF40F8E55C570C9FE38B90E5D9ED2B4BB16343AB066568178AE6A0B94B350A6E761DB0368E2FD52889805A30DEA45047D8C7B427A2EB07477AF537D27606A4F310CBDDFD9EB102652CE9717F52ABCB6B0813D6EACD0479E9FD76BFB65951D105A44B42A6C11FC6865BD2BEAAAEAD6A6974E50B8F10EA563DB2C7F9D2'/>");

                    step("check activated ca-certs");
                    clientData("<List type='0-BACnetWsAuth/ca-certs'/>");
                    path("/.auth/ca-certs");
                    get();
                    expectClientData(
                            "<List type='0-BACnetWsAuth/ca-certs'>" +
                                    "    <OctetString name='1' value='308204333082031BA00302010202090083297BBEA7D8A228300D06092A864886F70D0101050500306E310B30090603550406130255533110300E0603550408130747656F726769613110300E0603550407130741746C616E74613111300F060355040A1308414D504949204341312830260603550403131F616D7069692E6F726720436572746966696361746520417574686F72697479301E170D3135313230323231353031385A170D3138303832373231353031385A306E310B30090603550406130255533110300E0603550408130747656F726769613110300E0603550407130741746C616E74613111300F060355040A1308414D504949204341312830260603550403131F616D7069692E6F726720436572746966696361746520417574686F7269747930820122300D06092A864886F70D01010105000382010F003082010A0282010100E67E09B15F8EF5D8BCD50B1375101EB559A097D84F658298581A0CE30632BF6A4615100FC8924503942117023EFB857139C7BD363EA9B8BD6564EF0F68E23031EF3CAA79B2F73696EAD5C9AF621D1B3E1DC1822457952890729C1A7C7AB4A4A4F7413998540D8FFB33A55787C7E36C81BC6A7B06126767C930517FF46CA688E533DD4BE773EB4163F58024894D81DFD17499B716B7645FB9CCCA8F23AFEB8BEDE4EBBE3B45651F443BDDB5E649DAAB703CD8A9C13014AE29575E72C74B8E65207945ABF0E5A782BEB953E0B643C8C3191D1F3FB84D167C71500E43ACB4E31529B34E8E2A24055A02412D914FD303BD99C2D67BBF43BEB3607A245856596D184F0203010001A381D33081D0301D0603551D0E04160414F0FCA52F7CEAFB41C0A1097651223C00599A32303081A00603551D230481983081958014F0FCA52F7CEAFB41C0A1097651223C00599A3230A172A470306E310B30090603550406130255533110300E0603550408130747656F726769613110300E0603550407130741746C616E74613111300F060355040A1308414D504949204341312830260603550403131F616D7069692E6F726720436572746966696361746520417574686F7269747982090083297BBEA7D8A228300C0603551D13040530030101FF300D06092A864886F70D0101050500038201010072FB91961F6AD3DA4F8FA741698B7EB89C4AD1F50BBCD52B5AB2202FACA7F07482BB619FAD0B58FCEE13A897CD8448FC99084FBDE640B0D6E38F4FF59529DCF5EE0ACD3E87F25C26EA8B86160D8822CB991DE399A9C145B856DB4BA79969D884D871137840E18F5C61B811BD3A317220E8C0FC486A5CC63F5EF3AFAC86DCF3C73345448E9949942E9C261B14641172AA69A75A70C36E395852D867DA35A0DB4458D6E7C9DAB8E7286F86F12E4C741EA2D9954E1AE06F7B5BDAFEB9A1B7E5FFFC6160A707048A67E5F001245BBE380777590FD96657F59C7B88E0DE15DD71BB6E7DDF1361E083D41788264E077012DBF74E032AE8F403050F1807B7E8EECF167D'/>" +
                                    "</List>");


                }
            },
            new Test("Internal Auth Server Test"){
                public void execute() throws TestException {

                    step("attempt read user/pass/id/secret");
                    path("/.auth/int/user");
                    get();
                    expectStatusCode(Errors.statusCodeForErrorNumber(Errors.NOT_READABLE));
                    expectErrorNumber(Errors.NOT_READABLE);
                    path("/.auth/int/pass");
                    get();
                    expectStatusCode(Errors.statusCodeForErrorNumber(Errors.NOT_READABLE));
                    expectErrorNumber(Errors.NOT_READABLE);
                    path("/.auth/int/id");
                    get();
                    expectStatusCode(Errors.statusCodeForErrorNumber(Errors.NOT_READABLE));
                    expectErrorNumber(Errors.NOT_READABLE);
                    path("/.auth/int/secret");
                    get();
                    expectStatusCode(Errors.statusCodeForErrorNumber(Errors.NOT_READABLE));
                    expectErrorNumber(Errors.NOT_READABLE);

                    step("attempt write user/pass/id/secret without authorization");
                    clientData("<String name='data' value='joe'/>");
                    path("/.auth/int/user");
                    put();
                    expectStatusCode(Errors.statusCodeForErrorNumber(Errors.NOT_AUTHORIZED));
                    expectErrorNumber(Errors.NOT_AUTHORIZED);
                    clientData("<String name='data' value='letmein'/>");
                    path("/.auth/int/user");
                    put();
                    expectStatusCode(Errors.statusCodeForErrorNumber(Errors.NOT_AUTHORIZED));
                    expectErrorNumber(Errors.NOT_AUTHORIZED);
                    clientData("<String name='data' value='CLIENT1234'/>");
                    path("/.auth/int/id");
                    put();
                    expectStatusCode(Errors.statusCodeForErrorNumber(Errors.NOT_AUTHORIZED));
                    expectErrorNumber(Errors.NOT_AUTHORIZED);
                    clientData("<String name='data' value='super-secret'/>");
                    path("/.auth/int/secret");
                    put();
                    expectStatusCode(Errors.statusCodeForErrorNumber(Errors.NOT_AUTHORIZED));
                    expectErrorNumber(Errors.NOT_AUTHORIZED);

                    step("get token for scope 'auth' using default username and password");
                    path("/.auth/int/token");
                    scheme("https"); // very important :-);
                    requestHeader("Content-Type", "application/x-www-form-urlencoded");
                    requestText(HTTP.x_www_url_form_encoded(
                            "scope", "auth",
                            "grant_type", "password",
                            "username", ".",
                            "password", "."));
                    post();
                    alt("json"); // response is in JSON
                    expectResponseDataItemValue("token_type", "Bearer");
                    expectResponseDataItemPresent("expires_in");
                    expectResponseDataItemPresent("access_token");
                    //
                    String token = getResponseData().stringValueOf("access_token", null);
                    if (token==null || token.isEmpty()) fail("access token is missing or empty");
                    //
                    step("use token to write new values to user/pass/id/secret");
                    requestHeader("Authorization", "Bearer " + token);
                    clientData("<String name='user' value='joe'/>");
                    path("/.auth/int/user");
                    put();
                    expectSuccessCode();
                    clientData("<String name='pass' value='letmein'/>");
                    path("/.auth/int/pass");
                    put();
                    expectSuccessCode();
                    clientData("<String name='id' value='CLIENT1234'/>");
                    path("/.auth/int/id");
                    put();
                    expectSuccessCode();
                    clientData("<String name='secret' value='super-secret'/>");
                    path("/.auth/int/secret");
                    put();
                    expectSuccessCode();

                    step("get a token using the new user/pass and grant_type='password'");
                    requestHeader("Authorization", null); // remove authorization header for password grant typwe
                    path("/.auth/int/token");
                    scheme("https"); // very important :-);
                    requestHeader("Content-Type", "application/x-www-form-urlencoded");
                    requestText(HTTP.x_www_url_form_encoded(
                            "scope", "auth",
                            "grant_type", "password",
                            "username", "joe",
                            "password", "letmein"));
                    post();
                    alt("json"); // response is in JSON
                    expectResponseDataItemValue("token_type", "Bearer");
                    expectResponseDataItemPresent("expires_in");
                    expectResponseDataItemPresent("access_token");

                    step("get a token using the new id/secret and grant_type='client_credentials' (and HTTP Basic auth);");
                    requestHeader("Authorization",HTTP.generateBasicAuthorization("CLIENT1234","super-secret")); // use Basic for client auth
                    path("/.auth/int/token");
                    scheme("https"); // very important :-);
                    requestHeader("Content-Type", "application/x-www-form-urlencoded");
                    requestText(HTTP.x_www_url_form_encoded(
                            "scope", "auth",
                            "grant_type", "client_credentials"));
                    post();
                    alt("json"); // response is in JSON
                    expectResponseDataItemValue("token_type", "Bearer");
                    expectResponseDataItemPresent("expires_in");
                    expectResponseDataItemPresent("access_token");

                }
            }
    };

}